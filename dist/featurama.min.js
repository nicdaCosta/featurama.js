/*! featurama.js - v0.0.8 - 2013-06-27
* https://github.com/nicdacosta/featurama.js
* Copyright (c) 2013 Nic da Costa; Licensed MIT */
window.featurama=function(window,document,undefined){"use strict";var head=document.head||document.getElementsByTagName("head")[0],storagePrefix="featurama-",RSVP=window.RSVP,getURL=function(e){var t=new RSVP.Promise(function(t,n){var r=new XMLHttpRequest;r.open("GET",e),r.onreadystatechange=function(){return 4===r.readyState?200===r.status?t(r.responseText):n(Error(r.statusText)):undefined}});return t},injectScript=function(e){var t=document.createElement("script");t.defer=!0,t.text=e,head.appendChild(t)},addToLocalStorage=function(e,t){e=e||"key";var n=extendObject({},t),r=typeof n.custom;n.custom="function"===r?"("+(""+n.custom)+")":Array.isArray(n.custom)?"["+(""+n.custom)+"]":n.custom,window.localStorage.setItem(storagePrefix+e,JSON.stringify(n))},getFromLocalStorage=function(key){key=key||"key";var obj;try{var item=window.localStorage.getItem(storagePrefix+key);obj=JSON.parse(item||"false"),obj.custom=obj.custom?eval(obj.custom):obj.custom}catch(e){obj=!1}return obj},removeFromLocalStorage=function(e){e=e||"key",window.localStorage.removeItem(storagePrefix+e)},getAllFromLocalStorage=function(){var e,t,n=window.localStorage,r=[];for(e in n)t=e.split(storagePrefix)[1],t&&r.push(t);return r},needsUpdate=function(e){var t=e.key||"key",n=e.version||0,r=getFromLocalStorage(t),o=!0;return r&&(o=n!==r.version?!0:!1),o},extendObject=function(e,t,n){e="object"==typeof e?e:{},t="object"==typeof t?t:{},n="boolean"==typeof n?n:!0;var r=Object.getOwnPropertyNames(t);return r.forEach(function(r){r=r,r&&t.hasOwnProperty(r)&&t[r]!==undefined&&(e[r]===undefined||n)&&(e[r]=t[r])}),e},getConfigResult=function(e){e=e||"key";var t,n,r=_featurama.config;return r!==undefined&&r.hasOwnProperty(e)&&r[e]!==undefined&&(t=r[e],t.regex instanceof RegExp?(t.regex.lastIndex=0,n=t.regex.test(window.navigator.userAgent)?t.result:undefined):t.regex instanceof Array&&t.regex.forEach(function(e){e instanceof RegExp&&(e.lastIndex=0,n=t.regex.test(window.navigator.userAgent)?t.result:undefined)})),n},removeConfigResult=function(e){e=e||"key";var t=_featurama.config||{};t.hasOwnProperty(e)&&(t[e]=undefined)},removeResult=function(e){e=e||"key";var t=_featurama.results||{};t.hasOwnProperty(e)&&(t[e]=undefined)},getProperty=function(e){e=e||"";var t=new RSVP.Promise(function(t){window.Modernizr!==undefined?t(window.Modernizr.hasOwnProperty(e)?window.Modernizr[e]:!1):t(getURL("").then(function(t){return injectScript(t),getProperty(e)}))});return t},handleTests=function(){for(var e,t=[],n=0,r=arguments.length,o=_featurama.results;r>n;n++)e=arguments[n].key||"key",t.push(o.hasOwnProperty(e)&&o[e]!==undefined?new RSVP.Promise(function(t){t(o[e])}):runTest(arguments[n]));return RSVP.all(t)},runTest=function(e){var t,n=e.Modernizr||[],r=e.custom||[],o=typeof r,a=e.key||n[0]||"key",u=e.keepExisting!==undefined?e.keepExisting:!0,s=e.cacheTest!==undefined?e.cacheTest:!0,i=getConfigResult(a),c=[],f=[];return s&&needsUpdate(e)&&addToLocalStorage(a,e),i!==undefined?f.push(i):(n.forEach(function(e){c.push(getProperty(e))}),"function"===o?(i=r(),"object"==typeof i&&i.hasOwnProperty("_promiseCallbacks")?c.push(i):f.push(i)):r.forEach(function(e){"function"==typeof e&&(i=e(),"object"==typeof i&&i.hasOwnProperty("_promiseCallbacks")?c.push(i):f.push(i))})),t=c.length?RSVP.all(c).then(function(e){return f=f.concat(e),setResults({key:a,results:f,keepExisting:u})}):setResults({key:a,results:f,keepExisting:u})},rerunTest=function(e){var t,n;return e=e!==undefined?e:"key",t=getFromLocalStorage(e),t?(t.cacheTest=!1,t.keepExisting=!1,n=runTest.call(null,t)):n=new RSVP.Promise(function(e,t){t(Error("Test Does Not Exist"))}),n},setResults=function(e){var t,n=_featurama.results,r=e.key||"key",o=e.keepExisting,a=e.results||[],u=!0;return t=new RSVP.Promise(function(e){a.forEach(function(e){u=u&&e}),"object"!=typeof n&&(n={}),n[r]=n.hasOwnProperty(r)&&n[r]!==undefined&&o?n[r]:u,e(n[r])})},_featurama={run:function(){var e;try{e=handleTests.apply(null,arguments)}catch(t){}return e},rerun:function(e){var t=rerunTest(e);return t},remove:function(e){removeFromLocalStorage(e),removeResult(e),removeConfigResult(e)},clear:function(){var e=getAllFromLocalStorage();e.forEach(function(e){removeFromLocalStorage(e)}),_featurama.results={},_featurama.config={}},exists:function(e){return getFromLocalStorage(e)?!0:!1},keys:function(){return getAllFromLocalStorage()},results:{},config:{}};return _featurama}(window,document);